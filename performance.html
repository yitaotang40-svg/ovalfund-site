<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oval Fund | Performance</title>
  <meta name="description" content="Performance (from performance.csv), percent return only." />
  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    /* embed=1 或 iframe 内嵌：隐藏头尾/按钮，只显示图表主体 */
    body.embed .site-header,
    body.embed .footer,
    body.embed .page-actions { display:none !important; }
    body.embed main { padding-top: 0 !important; }
    body.embed .section { padding-top: 0 !important; border-top: none !important; }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="container">
      <div class="navbar">
        <a class="brand" href="index.html">
          <span>Oval Fund</span>
          <small>Performance</small>
        </a>

        <nav class="nav-links" aria-label="Primary">
          <a href="index.html#philosophy">理念</a>
          <a href="index.html#letters">投资人信</a>
          <a href="index.html#contact">联系</a>
          <a class="active" href="performance.html">业绩</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="section" style="border-top:none;">
      <div class="container">
        <h2>业绩曲线（Base = 100）</h2>

        <p class="lede">
          数据来自 <code>data/performance.csv</code>（Fund 使用 <code>Share Price</code>，基准使用 <code>SP500</code> / <code>BRK</code>）。
          图表仅展示累计收益率（%）。
        </p>

        <div class="note" style="margin-top:10px;">
          <b>数据状态：</b><span id="dataStatus">—</span>
          <span style="margin-left:10px;">（最新日期：<span id="lastDate">—</span>）</span>
        </div>

        <!-- 这里专门显示你要的“起始净值=100” -->
        <div class="note" id="navInfo" style="margin-top:6px;">
          —
        </div>

        <div class="chart-box" style="margin-top:16px; height:420px;">
          <canvas id="perfChart" aria-label="Performance chart" role="img"></canvas>
        </div>

        <!-- KPI -->
        <div class="stats" style="margin-top:14px; display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
          <div class="card" style="padding:14px 16px;">
            <div style="font-size:12px; letter-spacing:.06em; opacity:.75;">SINCE START</div>
            <div id="kpiSince" style="margin-top:6px; font-size:22px; font-weight:700;">—</div>
          </div>
          <div class="card" style="padding:14px 16px;">
            <div style="font-size:12px; letter-spacing:.06em; opacity:.75;">~ 1M</div>
            <div id="kpi1m" style="margin-top:6px; font-size:22px; font-weight:700;">—</div>
          </div>
          <div class="card" style="padding:14px 16px;">
            <div style="font-size:12px; letter-spacing:.06em; opacity:.75;">~ 3M</div>
            <div id="kpi3m" style="margin-top:6px; font-size:22px; font-weight:700;">—</div>
          </div>
          <div class="card" style="padding:14px 16px;">
            <div style="font-size:12px; letter-spacing:.06em; opacity:.75;">MAX DRAWDOWN</div>
            <div id="kpiMdd" style="margin-top:6px; font-size:22px; font-weight:700;">—</div>
          </div>
        </div>

        <div class="page-actions" style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="index.html">返回首页</a>
          <a class="btn primary" href="index.html#contact">获取完整材料</a>
        </div>

      </div>
    </section>

    <div class="footer">
      <div class="container">
        <div>© <span id="year"></span> Oval Fund. All rights reserved.</div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <script defer>
    (() => {
      const DATA_URL = 'data/performance.csv';
      const el = (id) => document.getElementById(id);

      function setEmbedModeIfNeeded() {
        const params = new URLSearchParams(window.location.search);
        const embed = params.get('embed') === '1';
        const inIframe = (() => { try { return window.self !== window.top; } catch { return true; } })();
        if (embed || inIframe) document.body.classList.add('embed');
      }

      function parseCSV(text) {
        const rows = [];
        let row = [];
        let field = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const c = text[i];
          if (inQuotes) {
            if (c === '"') {
              if (text[i + 1] === '"') { field += '"'; i++; }
              else { inQuotes = false; }
            } else field += c;
          } else {
            if (c === '"') inQuotes = true;
            else if (c === ',') { row.push(field); field = ''; }
            else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ''; }
            else if (c === '\r') {}
            else field += c;
          }
        }
        if (field.length || row.length) { row.push(field); rows.push(row); }
        return rows.filter(r => r.some(v => String(v).trim() !== ''));
      }

      function normalizeHeader(h) {
        return String(h || '')
          .replace(/^\uFEFF/, '')
          .trim()
          .toLowerCase()
          .replace(/\s+/g, ' ');
      }

      function findCol(headers, candidates) {
        const map = headers.map(normalizeHeader);
        for (const cand of candidates) {
          const idx = map.indexOf(normalizeHeader(cand));
          if (idx !== -1) return idx;
        }
        return -1;
      }

      function parseNumber(v) {
        const s = String(v ?? '').trim();
        if (!s) return NaN;
        const cleaned = s.replace(/[%$]/g, '').replace(/,/g, '').replace(/\s+/g, '');
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : NaN;
      }

      function parseDateValue(s) {
        const str = String(s || '').trim();
        if (!str) return null;
        if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(str)) {
          const [y,m,d] = str.split('-').map(n => parseInt(n,10));
          return new Date(Date.UTC(y, m-1, d));
        }
        if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(str)) {
          const [m,d,y] = str.split('/').map(n => parseInt(n,10));
          return new Date(Date.UTC(y, m-1, d));
        }
        const t = Date.parse(str);
        if (!Number.isFinite(t)) return null;
        const d = new Date(t);
        return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
      }

      function formatISODate(d) {
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth()+1).padStart(2,'0');
        const dd = String(d.getUTCDate()).padStart(2,'0');
        return `${y}-${m}-${dd}`;
      }

      function fmtPct(x, decimals=2) {
        if (!Number.isFinite(x)) return '—';
        const sign = x > 0 ? '+' : '';
        return `${sign}${(x*100).toFixed(decimals)}%`;
      }

      function fmtMoney(x) {
        if (!Number.isFinite(x)) return '—';
        return '$' + x.toFixed(2);
      }

      function computeMaxDrawdown(indexSeries) {
        let peak = -Infinity, maxDD = 0;
        for (const v of indexSeries) {
          if (!Number.isFinite(v)) continue;
          if (v > peak) peak = v;
          if (peak > 0) {
            const dd = v / peak - 1;
            if (dd < maxDD) maxDD = dd;
          }
        }
        return maxDD;
      }

      function returnOverDays(dates, indexSeries, days) {
        const lastIdx = dates.length - 1;
        const targetMs = dates[lastIdx].getTime() - days * 86400000;
        let anchor = 0;
        for (let i = lastIdx; i >= 0; i--) {
          if (dates[i].getTime() <= targetMs) { anchor = i; break; }
        }
        const v0 = indexSeries[anchor], v1 = indexSeries[lastIdx];
        if (!Number.isFinite(v0) || !Number.isFinite(v1) || v0 === 0) return NaN;
        return v1 / v0 - 1;
      }

      async function loadAndRender() {
        setEmbedModeIfNeeded();
        el('year').textContent = new Date().getFullYear();

        const setStatus = (msg) => el('dataStatus').textContent = msg;
        setStatus('正在加载…');

        let text = '';
        try {
          const res = await fetch(DATA_URL, { cache:'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          text = await res.text();
        } catch (e) {
          console.error(e);
          setStatus(`加载失败：无法访问 ${DATA_URL}`);
          return;
        }

        const rows = parseCSV(text);
        if (rows.length < 2) { setStatus('CSV 格式不正确或为空'); return; }

        const headers = rows[0];
        const idxDate = findCol(headers, ['Date','日期']);
        const idxSharePrice = findCol(headers, ['Share Price','SharePrice','NAV','Unit Price','单位净值']);
        const idxSP = findCol(headers, ['SP500','S&P 500','SP 500','SPX']);
        const idxBRK = findCol(headers, ['BRK','BRK.B','BRK B']);

        if (idxDate===-1 || idxSharePrice===-1 || idxSP===-1 || idxBRK===-1) {
          setStatus('缺少必要列：Date / Share Price / SP500 / BRK');
          return;
        }

        const dates=[], fund=[], sp=[], brk=[];
        for (let i=1;i<rows.length;i++){
          const r = rows[i];
          const d = parseDateValue(r[idxDate]);
          const f = parseNumber(r[idxSharePrice]);
          const s = parseNumber(r[idxSP]);
          const b = parseNumber(r[idxBRK]);
          if (!d || !Number.isFinite(f) || !Number.isFinite(s) || !Number.isFinite(b)) continue;
          dates.push(d); fund.push(f); sp.push(s); brk.push(b);
        }
        if (dates.length < 2) { setStatus('有效数据太少'); return; }

        // sort
        const order = dates.map((d,i)=>({t:d.getTime(),i})).sort((a,b)=>a.t-b.t).map(o=>o.i);
        const dS = order.map(i=>dates[i]);
        const fS = order.map(i=>fund[i]);
        const sS = order.map(i=>sp[i]);
        const bS = order.map(i=>brk[i]);

        const baseF = fS[0], baseS=sS[0], baseB=bS[0];
        const fundIndex = fS.map(v => (v/baseF)*100);
        const spIndex   = sS.map(v => (v/baseS)*100);
        const brkIndex  = bS.map(v => (v/baseB)*100);

        const fundRet = fundIndex.map(v=>v-100);
        const spRet   = spIndex.map(v=>v-100);
        const brkRet  = brkIndex.map(v=>v-100);

        const sinceStart = fundIndex.at(-1)/100 - 1;
        const r1m = returnOverDays(dS, fundIndex, 30);
        const r3m = returnOverDays(dS, fundIndex, 90);
        const mdd = computeMaxDrawdown(fundIndex);

        el('kpiSince').textContent = fmtPct(sinceStart);
        el('kpi1m').textContent = fmtPct(r1m);
        el('kpi3m').textContent = fmtPct(r3m);
        el('kpiMdd').textContent = fmtPct(mdd);

        const startDate = formatISODate(dS[0]);
        const lastDate  = formatISODate(dS.at(-1));
        el('lastDate').textContent = lastDate;
        setStatus(`已加载 ${dS.length} 条记录`);

        // ✅ 这里显示你要的“起始=100”以及最新净值
        el('navInfo').textContent =
          `起始净值（股价）: ${fmtMoney(baseF)}（${startDate}）  |  最新净值: ${fmtMoney(fS.at(-1))}（${lastDate}）`;

        const labels = dS.map(formatISODate);

        if (window.__perfChart) window.__perfChart.destroy();
        window.__perfChart = new Chart(el('perfChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label:'Fund', data: fundRet, borderColor:'#2563eb', borderWidth:2, pointRadius:0, tension:0.25 },
              { label:'S&P 500', data: spRet, borderColor:'#ef4444', borderWidth:2, pointRadius:0, tension:0.25 },
              { label:'BRK', data: brkRet, borderColor:'#f59e0b', borderWidth:2, pointRadius:0, tension:0.25 },
            ]
          },
          options: {
            responsive:true,
            maintainAspectRatio:false,
            interaction:{ mode:'index', intersect:false },
            plugins:{
              legend:{ position:'top' },
              tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%` } }
            },
            scales:{
              x:{ ticks:{ maxTicksLimit:8 } },
              y:{ ticks:{ callback:(v)=>`${Number(v).toFixed(2)}%` } }
            }
          }
        });
      }

      document.addEventListener('DOMContentLoaded', loadAndRender);
    })();
  </script>
</body>
</html>
