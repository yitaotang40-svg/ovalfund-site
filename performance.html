<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oval Fund | Performance</title>
  <meta name="description" content="Performance (from performance.csv) with cashflow markers." />
  <link rel="stylesheet" href="assets/css/styles.css" />

  <!-- 只在本页用到的小样式：入金表格 + embed 模式 -->
  <style>
    .cf-table-wrap { overflow:auto; }
    .cf-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .cf-table th, .cf-table td {
      padding: 10px 8px;
      border-top: 1px solid rgba(0,0,0,.08);
      vertical-align: top;
    }
    .cf-table th {
      text-align: left;
      font-size: 12px;
      letter-spacing: .06em;
      opacity: .7;
      border-top: none;
    }
    .cf-amt { text-align: right; white-space: nowrap; }
    .cf-sum {
      margin-top: 10px;
      font-size: 13px;
      opacity: .8;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* embed=1 或 iframe 内嵌：隐藏头尾/按钮，只显示图表主体 */
    body.embed .site-header,
    body.embed .footer,
    body.embed .page-actions { display:none !important; }
    body.embed main { padding-top: 0 !important; }
    body.embed .section { padding-top: 0 !important; border-top: none !important; }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="container">
      <div class="navbar">
        <a class="brand" href="index.html">
          <span>Oval Fund</span>
          <small>Performance</small>
        </a>

        <nav class="nav-links" aria-label="Primary">
          <a href="index.html#philosophy">理念</a>
          <a href="index.html#letters">投资人信</a>
          <a href="index.html#contact">联系</a>
          <a class="active" href="performance.html">业绩</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="section" style="border-top:none;">
      <div class="container">
        <h2>业绩曲线（Base = 100）</h2>

        <p class="lede">
          数据来自 <code>data/performance.csv</code>（基金用 <code>Share Price</code> 作为单位净值；基准用 <code>SP500</code> / <code>BRK</code>）。
          图中竖虚线为入金时间（Transfer）。
        </p>

        <div class="note" style="margin-top:10px;">
          <b>数据状态：</b><span id="dataStatus">—</span>
          <span style="margin-left:10px;">（最新日期：<span id="lastDate">—</span>）</span>
        </div>

        <div class="chart-box" style="margin-top:16px; height:420px;">
          <canvas id="perfChart" aria-label="Performance chart" role="img"></canvas>
        </div>

        <!-- KPI -->
        <div class="stats" style="margin-top:14px; display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
          <div class="card" style="padding:14px 16px;">
            <div style="font-size:12px; letter-spacing:.06em; opacity:.75;">SINCE START</div>
            <div id="kpiSince" style="margin-top:6px; font-size:22px; font-weight:700;">—</div>
          </div>
          <div class="card" style="padding:14px 16px;">
            <div style="font-size:12px; letter-spacing:.06em; opacity:.75;">~ 1M</div>
            <div id="kpi1m" style="margin-top:6px; font-size:22px; font-weight:700;">—</div>
          </div>
          <div class="card" style="padding:14px 16px;">
            <div style="font-size:12px; letter-spacing:.06em; opacity:.75;">~ 3M</div>
            <div id="kpi3m" style="margin-top:6px; font-size:22px; font-weight:700;">—</div>
          </div>
          <div class="card" style="padding:14px 16px;">
            <div style="font-size:12px; letter-spacing:.06em; opacity:.75;">MAX DRAWDOWN</div>
            <div id="kpiMdd" style="margin-top:6px; font-size:22px; font-weight:700;">—</div>
          </div>
        </div>

        <div class="page-actions" style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="index.html">返回首页</a>
          <a class="btn primary" href="index.html#contact">获取完整材料</a>
        </div>

        <!-- 入金列表 -->
        <div class="card" style="margin-top:18px;">
          <h3 style="margin-top:0;">入金记录（Transfer）</h3>
          <p class="note" style="margin-top:6px;">
            说明：以下入金来自你截图里的 IB 交易流水（Amount 列）。累计入金 = 26,996.94，与你的 Net Transfer 总额一致。
          </p>
          <div id="cashflowList" class="cf-table-wrap" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>

    <div class="footer">
      <div class="container">
        <div>© <span id="year"></span> Oval Fund. All rights reserved.</div>
      </div>
    </div>
  </main>

  <!-- Chart.js + 时间轴适配器（用于在非数据点日期画入金竖线） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3" defer></script>

  <script defer>
    (() => {


      const el = (id) => document.getElementById(id);

      function setEmbedModeIfNeeded() {
        const params = new URLSearchParams(window.location.search);
        const embed = params.get('embed') === '1';
        const inIframe = (() => { try { return window.self !== window.top; } catch { return true; } })();
        if (embed || inIframe) document.body.classList.add('embed');
      }

      function parseCSV(text) {
        const rows = [];
        let row = [];
        let field = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const c = text[i];

          if (inQuotes) {
            if (c === '"') {
              if (text[i + 1] === '"') { field += '"'; i++; }
              else { inQuotes = false; }
            } else {
              field += c;
            }
          } else {
            if (c === '"') inQuotes = true;
            else if (c === ',') { row.push(field); field = ''; }
            else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ''; }
            else if (c === '\r') { /* ignore */ }
            else { field += c; }
          }
        }
        if (field.length || row.length) { row.push(field); rows.push(row); }
        return rows.filter(r => r.some(v => String(v).trim() !== ''));
      }

      function normalizeHeader(h) {
        return String(h || '')
          .replace(/^\uFEFF/, '')
          .trim()
          .toLowerCase()
          .replace(/\s+/g, ' ');
      }

      function findCol(headers, candidates) {
        const map = headers.map(normalizeHeader);
        for (const cand of candidates) {
          const idx = map.indexOf(normalizeHeader(cand));
          if (idx !== -1) return idx;
        }
        return -1;
      }

      function parseNumber(v) {
        if (v == null) return NaN;
        const s = String(v).trim();
        if (!s) return NaN;
        const cleaned = s.replace(/[%$]/g, '').replace(/,/g, '').replace(/\s+/g, '');
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : NaN;
      }

      function parseDateValue(s) {
        const str = String(s || '').trim();
        if (!str) return null;

        // YYYY-MM-DD
        if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(str)) {
          const [y, m, d] = str.split('-').map(n => parseInt(n, 10));
          return new Date(Date.UTC(y, m - 1, d));
        }

        // M/D/YYYY
        if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(str)) {
          const [m, d, y] = str.split('/').map(n => parseInt(n, 10));
          return new Date(Date.UTC(y, m - 1, d));
        }

        const t = Date.parse(str);
        if (!Number.isFinite(t)) return null;
        const d = new Date(t);
        return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
      }

      function formatISODate(d) {
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth() + 1).padStart(2, '0');
        const dd = String(d.getUTCDate()).padStart(2, '0');
        return `${y}-${m}-${dd}`;
      }

      function fmtPct(x, decimals = 2) {
        if (!Number.isFinite(x)) return '—';
        const sign = x > 0 ? '+' : '';
        return `${sign}${(x * 100).toFixed(decimals)}%`;
      }

      function money(x) {
        if (!Number.isFinite(x)) return '—';
        return '$' + x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function computeMaxDrawdown(indexSeries) {
        let peak = -Infinity;
        let maxDD = 0; // 负数
        for (const v of indexSeries) {
          if (!Number.isFinite(v)) continue;
          if (v > peak) peak = v;
          if (peak > 0) {
            const dd = v / peak - 1;
            if (dd < maxDD) maxDD = dd;
          }
        }
        return maxDD;
      }

      function returnOverDays(dates, indexSeries, days) {
        if (!dates.length || dates.length !== indexSeries.length) return NaN;
        const lastIdx = dates.length - 1;
        const lastDate = dates[lastIdx];
        const targetMs = lastDate.getTime() - days * 24 * 60 * 60 * 1000;

        let anchor = 0;
        for (let i = lastIdx; i >= 0; i--) {
          if (dates[i].getTime() <= targetMs) { anchor = i; break; }
        }

        const v0 = indexSeries[anchor];
        const v1 = indexSeries[lastIdx];
        if (!Number.isFinite(v0) || !Number.isFinite(v1) || v0 === 0) return NaN;
        return v1 / v0 - 1;
      }

      function renderCashflows() {
        const total = CASHFLOWS.reduce((s, x) => s + (Number(x.amount) || 0), 0);

        const rows = CASHFLOWS
          .slice()
          .sort((a, b) => a.date.localeCompare(b.date))
          .map(x => `
            <tr>
              <td>${x.date}</td>
              <td class="cf-amt">${money(x.amount)}</td>
            </tr>
          `).join('');

        el('cashflowList').innerHTML = `
          <table class="cf-table" aria-label="Cashflow table">
            <thead>
              <tr>
                <th>DATE</th>
                <th class="cf-amt">AMOUNT</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
          <div class="cf-sum">
            <div>次数：<b>${CASHFLOWS.length}</b></div>
            <div>累计入金：<b>${money(total)}</b></div>
          </div>
        `;
      }

      async function loadAndRender() {
        setEmbedModeIfNeeded();
        renderCashflows();

        el('year').textContent = new Date().getFullYear();

        const status = el('dataStatus');
        const setStatus = (msg) => { if (status) status.textContent = msg; };
        setStatus('正在加载…');

        let text = '';
        try {
          const res = await fetch(DATA_URL, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          text = await res.text();
        } catch (err) {
          console.error(err);
          setStatus(`加载失败：无法访问 ${DATA_URL}`);
          return;
        }

        const rows = parseCSV(text);
        if (rows.length < 2) {
          setStatus('数据为空或 CSV 格式不正确（至少需要表头 + 1 行）。');
          return;
        }

        const headers = rows[0];

        const idxDate = findCol(headers, ['Date', '日期']);
        const idxSharePrice = findCol(headers, ['Share Price', 'SharePrice', 'NAV', 'Unit Price', '单位净值']);
        const idxSP = findCol(headers, ['SP500', 'S&P 500', 'SP 500', 'SPX']);
        const idxBRK = findCol(headers, ['BRK', 'BRK.B', 'BRK B', 'BRK Price']);

        if (idxDate === -1) { setStatus('缺少 Date 列。'); return; }
        if (idxSharePrice === -1) { setStatus('缺少 Share Price 列。'); return; }
        if (idxSP === -1) { setStatus('缺少 SP500 列。'); return; }
        if (idxBRK === -1) { setStatus('缺少 BRK 列。'); return; }

        const dates = [];
        const fund = [];
        const sp = [];
        const brk = [];

        for (let i = 1; i < rows.length; i++) {
          const r = rows[i];
          const d = parseDateValue(r[idxDate]);
          if (!d) continue;

          const f = parseNumber(r[idxSharePrice]);
          const s = parseNumber(r[idxSP]);
          const b = parseNumber(r[idxBRK]);

          if (!Number.isFinite(f) || !Number.isFinite(s) || !Number.isFinite(b)) continue;

          dates.push(d);
          fund.push(f);
          sp.push(s);
          brk.push(b);
        }

        if (dates.length < 2) {
          setStatus('有效数据行太少（需要至少 2 行）。');
          return;
        }

        // 按日期升序
        const order = dates.map((d, i) => ({ t: d.getTime(), i }))
                           .sort((a, b) => a.t - b.t)
                           .map(o => o.i);

        const dS = order.map(i => dates[i]);
        const fS = order.map(i => fund[i]);
        const sS = order.map(i => sp[i]);
        const bS = order.map(i => brk[i]);

        // Base=100 index
        const baseF = fS[0];
        const baseS = sS[0];
        const baseB = bS[0];

        const fundIndex = fS.map(v => (v / baseF) * 100);
        const spIndex   = sS.map(v => (v / baseS) * 100);
        const brkIndex  = bS.map(v => (v / baseB) * 100);

        const fundRet = fundIndex.map(v => v - 100);
        const spRet   = spIndex.map(v => v - 100);
        const brkRet  = brkIndex.map(v => v - 100);

        // KPI
        const sinceStart = fundIndex[fundIndex.length - 1] / 100 - 1;
        const r1m = returnOverDays(dS, fundIndex, 30);
        const r3m = returnOverDays(dS, fundIndex, 90);
        const mdd = computeMaxDrawdown(fundIndex);

        el('kpiSince').textContent = fmtPct(sinceStart);
        el('kpi1m').textContent = fmtPct(r1m);
        el('kpi3m').textContent = fmtPct(r3m);
        el('kpiMdd').textContent = fmtPct(mdd);

        el('lastDate').textContent = formatISODate(dS[dS.length - 1]);
        setStatus(`已加载 ${dS.length} 条记录`);

        // 入金竖线插件（time scale 下可画在任意日期）
        const cashflowLinesPlugin = {
          id: 'cashflowLines',
          afterDatasetsDraw(chart) {
            const { ctx, chartArea, scales } = chart;
            const x = scales.x;
            if (!x || !chartArea) return;

            ctx.save();
            ctx.strokeStyle = 'rgba(0,0,0,0.18)';
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 1;

            for (const cf of CASHFLOWS) {
              const t = new Date(cf.date + 'T00:00:00Z');
              const px = x.getPixelForValue(t);
              if (!Number.isFinite(px)) continue;
              if (px < chartArea.left || px > chartArea.right) continue;

              ctx.beginPath();
              ctx.moveTo(px, chartArea.top);
              ctx.lineTo(px, chartArea.bottom);
              ctx.stroke();
            }

            ctx.restore();
          }
        };

        const seriesFund = dS.map((d, i) => ({ x: d, y: fundRet[i] }));
        const seriesSP   = dS.map((d, i) => ({ x: d, y: spRet[i] }));
        const seriesBRK  = dS.map((d, i) => ({ x: d, y: brkRet[i] }));

        const canvas = el('perfChart');
        if (window.__perfChart) { window.__perfChart.destroy(); window.__perfChart = null; }

        window.__perfChart = new Chart(canvas, {
          type: 'line',
          data: {
            datasets: [
              { label: 'Fund',    data: seriesFund, borderColor: '#2563eb', borderWidth: 2, pointRadius: 0, tension: 0.25 },
              { label: 'S&P 500', data: seriesSP,   borderColor: '#ef4444', borderWidth: 2, pointRadius: 0, tension: 0.25 },
              { label: 'BRK',     data: seriesBRK,  borderColor: '#f59e0b', borderWidth: 2, pointRadius: 0, tension: 0.25 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                }
              }
            },
            scales: {
              x: {
                type: 'time',
                time: { unit: 'week' },
                ticks: { maxTicksLimit: 8 }
              },
              y: {
                ticks: { callback: (v) => `${Number(v).toFixed(2)}%` }
              }
            }
          },
          plugins: [cashflowLinesPlugin]
        });
      }

      document.addEventListener('DOMContentLoaded', loadAndRender);
    })();
  </script>
</body>
</html>
